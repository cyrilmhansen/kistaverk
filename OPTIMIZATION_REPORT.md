# Size Optimization Report - Kistaverk

**Date:** December 10, 2025
**Target:** Android (`arm64-v8a`)
**Final APK Size (Unsigned):** ~5.5 MB

This document summarizes the actions taken to optimize the application's size and the remaining areas for improvement.

## 1. Current Status
The application consists of a native Android interface (Kotlin) and a Rust core logic (`libkistaverk_core.so`).

*   **Weight Distribution (Unsigned APK):**
    *   **Native Libs (`.so`)**: ~4.5 MB (82% of total)
    *   **Code (`classes.dex`)**: ~900 KB
    *   **Resources (`res/`)**: ~580 KB
    *   **Assets**: ~150 KB (after cleanup)

## 2. Actions Taken

### A. Rust Build Optimization
The following compilation flags have been validated and applied in `Cargo.toml` and `build.gradle.kts`:
*   `opt-level = "z"`: Aggressive optimization for size (instead of speed).
*   `lto = "fat"`: Global Link Time Optimization.
*   `panic = "abort"`: Removal of "stack unwinding" code (significant gain).
*   `strip = "symbols"`: Removal of debug symbols.
*   `CFLAGS = "-Os"`: Optimization for size of C/C++ dependencies (e.g., `blake3`, `zune-jpeg`).

### B. Architecture & ABI
*   **32-bit Test (`armeabi-v7a`)**: A pure 32-bit version is approximately **1 MB smaller** (~4.5 MB total) due to smaller pointers.
*   **Decision**: Retention of **64-bit (`arm64-v8a`)** as the primary target to ensure compatibility with modern devices (Pixel 7/8/9) and Play Store requirements. The "x32" mode (64-bit instructions, 32-bit pointers) is not supported by Android ART.

### C. Asset Cleanup
*   **PrismJS**: Removed ~160 KB of redundant JavaScript and CSS files (Prism core, individual languages) as the application uses a unified `prism-bundle.min.js`.

### D. Rust Dependency Analysis (`cargo bloat`)
Binary analysis reveals the main space consumers in the `.text` section (executable code):
1.  **`std`** (~433 KB): Incompressible.
2.  **`kistaverk_core`** (~280 KB): Business logic code.
3.  **`rxing`** (~244 KB): Barcode decoding library.
4.  **`regex_automata`** (~200 KB): Regular expression engine.
5.  **`image`** (~147 KB): Image processing.

Attempt to remove `unicode-perl` in `regex`: Ineffective because `rxing` forces the inclusion of these features.

## 3. Remaining Avenues & Points of Attention

### ðŸ”´ The `rxing` Case (High Priority)
The `rxing` library (ZXing port) is very heavy because it includes support for numerous formats (Aztec, PDF417, etc.) and pulls in costly regex dependencies.
*   **Recommended Action**: If usage is limited to QR codes, replace `rxing` with **`rqrr`** (much lighter) or `qrcode` (if reading is not required). This could save up to **500 KB**.

### ðŸŸ  Graphical Resources
Some WebP images in `res/` are quite large for UI assets:
*   `res/5c.webp` (99 KB)
*   `res/iE.webp` (59 KB)
*   **Recommended Action**: Replace with **Vector Drawables (XML)** for icons, or increase WebP compression for photos/illustrations.

### ðŸŸ¡ APK Compression
Currently, native libraries (`.so`) are **uncompressed** within the APK (implicit `extractNativeLibs="false"`).
*   **Advantage**: Faster installation, less disk space occupied on the phone.
*   **Disadvantage**: Larger APK to download.
*   **Action**: If the `.apk` file size is critical (low-bandwidth web distribution), enable native library compression in the manifest/gradle.

---
*Report generated by Gemini CLI Agent*